#
# Common rules for all DDP Makefiles
#
# This file, and only this file, tell how to generate
# description, poem, and commentary text load files from .e files,
# and how to load descriptions and commentary text and
# generate the corresponding "loaded" (.cld, .pld, and .tld) files.
#
# This file gets included from the Makefiles in the commentary
# and cantica directories.
#

userid	:=	dante/dante0614@dante		# corresponds to the "copper" database
#userid	:=	dante/dante0413@dante_baseline	# tin
#userid :=	dante/dante0711@dante_upgrade	# lead
#userid	:=	dante/dante0210@dante_silver	# silver

home	:=	/home/dante
#home	:=	/home/projects/dante

ctldir	:=	$(home)/SQL
commdir	:=	$(home)/Commentaries/
abspath	:=	$(shell pwd)
cantica	:=	$(notdir $(abspath))
relpath	:=	$(subst $(commdir),,$(abspath))

#
# For commentary description (desc.e) files
#

%.cdat:	%.e
	rm -f $@
	ddp2html < $< | \
	ddp2descsql $(comm_id) $(comm_name) $(comm_lang) > $@

%.cld:	%.cdat
	if [ -f $@ ];		\
	then			\
		sqlplus $(userid) @delete_desc $(comm_id) && rm -f $@;	\
	else			\
		true;		\
	fi
	sqlldr USERID=$(userid) CONTROL=$(ctldir)/ddp_comm_tab.ldrctl LOG=desc.log DATA=$< BAD=/dev/null
	touch $@

#
# For commentary text files
#

%.tdat:	%.e
	rm -f $@
	ddp2html < $< | \
	ddp2textsql $(relpath)/$*.e $(comm_id) $(comm_lang) $(cantica) $* > $@

%.tld:	%.tdat
	if [ -f $@ ];		\
	then			\
		sqlplus $(userid) @delete_text $(relpath)/$*.e && rm -f $@;	\
	else			\
		true;		\
	fi
	sqlldr USERID=$(userid) CONTROL=$(ctldir)/ddp_text_tab.ldrctl LOG=$*.log DATA=$< BAD=/dev/null
	touch $@

#
# For poem text files
#

%.pdat:	%.e
	rm -f $@
	ddp2html < $< | \
	ddp2poemsql $(relpath)/$< $(comm_id) $(comm_lang) $(cantica) $* > $@

%.pld:	%.pdat
	if [ -f $@ ];		\
	then			\
		sqlplus $(userid) @delete_text $(relpath)/$*.e && rm -f $@;	\
	else			\
		true;		\
	fi
	sqlldr USERID=$(userid) CONTROL=$(ctldir)/ddp_text_tab.ldrctl LOG=$*.log DATA=$< BAD=/dev/null
	touch $@
